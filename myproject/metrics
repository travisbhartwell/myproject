#!/usr/bin/env -S mycmd myproject run
# -*- mode: shell-script; sh-shell: bash; sh-basic-offset: 4; sh-indentation: 4; coding: utf-8 -*-
# shellcheck shell=bash

set -o nounset -o errexit -o errtrace -o pipefail

# --------------------------------------------------------------------------------------------------
# Metrics Tasks
function count_source_lines() {
    local -n fileset="${1}"

    # TODO: myproject.output_only_if_not_quiet
    # myproject.output_only_if_not_quiet "Counting source lines in fileset '${!fileset}'."
    mycmd.output "Counting source lines in fileset '${!fileset}'."
    wc -l "${fileset[@]}" | sort -nr
}

myproject.register_task_with_fileset count-all-source-lines \
    count_source_lines \
    ALL_FILES

myproject.register_task_with_fileset count-task-definition-source-lines \
    count_source_lines \
    TASK_DEFINITION_FILES

myproject.register_task_with_fileset count-implementation-source-lines \
    count_source_lines \
    IMPLEMENTATION_FILES

myproject.register_task_with_fileset count-test-source-lines \
    count_source_lines \
    TEST_FILES

function git_quick_stats() {
    if ! mycmd.init_bin_no_exit git-quick-stats; then
        mycmd.error_output "Required tool 'git-quick-stats' not found."
        return 1
    fi

    if mycmd.is_mac_os; then
        # shellcheck disable=SC2154
        /usr/bin/env PATH="${HOMEBREW_PREFIX}/opt/coreutils/libexec/gnubin:${HOMEBREW_PREFIX}/opt/gawk/libexec/gnubin:${PATH}" \
            git quick-stats "${@}"
    else
        git quick-stats "${@}"
    fi
}

myproject.register_task git-quick-stats git_quick_stats

mycmd.trace "Finished loading the metrics task definition file."
